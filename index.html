<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Molscreen Player</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            cursor: none;
        }

        #player-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.8s ease-in-out;
        }

        .hidden { opacity: 0; z-index: 1; }
        .visible { opacity: 1; z-index: 2; }
    </style>
</head>
<body>

    <div id="player-container">
        <video id="video1" class="visible" autoplay muted playsinline></video>
        <video id="video2" class="hidden" muted playsinline></video>
    </div>

    <script>
        const playlist = [
            "https://www.dropbox.com/scl/fi/cgq2z7linqasvqezbm8ab/gochits.mp4?rlkey=274k4goiciju5otq7qizctanh&st=u2qj0hb9&raw=1",
            "https://www.dropbox.com/scl/fi/b5h43u2gtqa9tb7mcvxg0/goge.mp4?rlkey=1zcjj2h6t7wvp3xz4kplnednr&st=ad2g4vla&raw=1",
            "https://www.dropbox.com/scl/fi/e2taoclzs6h5d09bi6vh2/kfc.mp4?rlkey=ti378vkzzqshy98i4xg7e2z13&st=xo7uj41y&raw=1",
            "https://www.dropbox.com/scl/fi/fjlmicsw8e3wocrnwvobh/mallscreen_promo.mp4?rlkey=7toe1bduhyx9ly42h7qbj1u23&st=fo8by9by&raw=1",
            "https://www.dropbox.com/scl/fi/k4pkuv2rqtzviddjnv5an/marge.mp4?rlkey=6a0d94c1shuqp9usqwggjxeim&st=by7r8osn&raw=1",
            "https://www.dropbox.com/scl/fi/7whs9yqdaiq0o4mvlarhb/satamashoebi.mp4?rlkey=dgqeekoyj8etov8on6k8vrxoy&st=i3z5izrb&raw=1",
            "https://www.dropbox.com/scl/fi/mbmod4obbvmuyiofc77ml/velosipedebi.mp4?rlkey=8gnk7u7w1hrzsvrd7z42n0dzk&st=4xjy6085&raw=1"
        ];

        let currentIndex = 0;
        const videos = [document.getElementById('video1'), document.getElementById('video2')];
        let activeVideoIndex = 0;
        const CACHE_NAME = 'molscreen-v2';

        async function getBestSource(url) {
            try {
                const cache = await caches.open(CACHE_NAME);
                const cachedResponse = await cache.match(url);
                if (cachedResponse) {
                    const blob = await cachedResponse.blob();
                    return URL.createObjectURL(blob);
                }
                fetch(url).then(res => {
                    if (res.ok) cache.put(url, res);
                }).catch(() => {});
            } catch (e) { console.error("Cache error", e); }
            return url;
        }

        async function setupVideo(videoElement, index, isInitial = false) {
            const url = playlist[index];
            if (isInitial) {
                videoElement.src = url;
            } else {
                const source = await getBestSource(url);
                videoElement.src = source;
            }
            videoElement.load();
        }

        async function swapVideos() {
            const currentVideo = videos[activeVideoIndex];
            activeVideoIndex = 1 - activeVideoIndex;
            const nextVideo = videos[activeVideoIndex];

            nextVideo.play().then(() => {
                nextVideo.classList.remove('hidden');
                nextVideo.classList.add('visible');
                currentVideo.classList.remove('visible');
                currentVideo.classList.add('hidden');

                setTimeout(() => {
                    if (currentVideo.src.startsWith('blob:')) {
                        URL.revokeObjectURL(currentVideo.src);
                    }
                    currentVideo.src = "";
                    currentVideo.load();
                }, 1000);

                currentIndex = (currentIndex + 1) % playlist.length;
                const nextIndex = (currentIndex + 1) % playlist.length;
                setupVideo(currentVideo, nextIndex);
            }).catch(() => {
                setTimeout(swapVideos, 2000);
            });
        }

        async function initPlayer() {
            await setupVideo(videos[0], 0, true);
            videos[0].play();
            setupVideo(videos[1], 1);
            videos[0].onended = swapVideos;
            videos[1].onended = swapVideos;
        }

        window.onload = initPlayer;

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
        }
    </script>
</body>
</html>
